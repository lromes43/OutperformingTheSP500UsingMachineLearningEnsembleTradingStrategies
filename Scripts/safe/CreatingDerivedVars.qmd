---
title: "Untitled"
format: html
---

```{python}
import pandas as pd
import yfinance as yf
import numpy as np
from plotnine import *
```

```{python}
data = pd.read_csv("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/SP500Initial.csv")
data.head()
```


```{python}
daily_return = []
for i in range(0, len(data)):
    previous_price = data['Close'].iloc[i-1]
    current_price = data['Close'].iloc[i]
    daily_return_rate = ((current_price - previous_price)/previous_price) * 100
    daily_return.append(daily_return_rate)

data['Daily_Return'] =  daily_return
data
```


```{python}
price_range = []
for i in range(0, len(data)):
    high = data['High'].iloc[i]
    low = data['Low'].iloc[i]
    p_range = high - low
    price_range.append(p_range)

price_range
data['Day_Range'] =   price_range
data
```


```{python}

data['SMA_5'] = data.groupby('Ticker')['Close'].rolling(window=5, min_periods=1).mean().reset_index(level=0, drop = True)
data['SMA_12'] = data.groupby('Ticker')['Close'].rolling(window = 12, min_periods=1).mean().reset_index(level=0, drop=True)
data['SMA_15'] = data.groupby('Ticker')['Close'].rolling(window=15, min_periods=1).mean().reset_index(level=0, drop = True)
data['SMA_20'] = data.groupby('Ticker')['Close'].rolling(window = 20, min_periods=1).mean().reset_index(level = 0, drop=True) #made so can calc bollinger bands
data['SMA_26'] = data.groupby('Ticker')['Close'].rolling(window=26, min_periods=1).mean().reset_index(level=0, drop=True)
data['SMA_30'] = data.groupby('Ticker')['Close'].rolling(window=30, min_periods=1).mean().reset_index(level=0, drop = True)
data['SMA_50'] = data.groupby('Ticker')['Close'].rolling(window=50, min_periods=1).mean().reset_index(level=0, drop = True)
data
```


```{python}

##Manual WAY!

#want to find EMA for N = 50,26,12, and 5
#EMA formula:  Price current  * (2/N+1) +EMA previous * ( 1- (2/N+1)) 

ticker_list = data['Ticker'].unique() 

subset = data[data['Ticker'] == "CSCO"].copy()

price_current = subset['Close'].iloc[0]

ema_previous = subset['SMA_50'].iloc[0]

N = 50
K = (2/N+1)

first_row_index = subset.index[0]
subset.loc[first_row_index, 'EMA_50'] = price_current * K + ema_previous * (1 - K)

subset
```

```{python}
#EMA
def ema_formula(price_current, ema_previous, N):
    K = 2/(N+1)
    return price_current * K + ema_previous * (1 - K)
```

```{python}
EMA_5 = []

for ticker in data["Ticker"].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_ema = []
    N = 5
    print(ticker)
    for i in range(0, len(subset)):
        print(i)
        price_current = subset['Close'].iloc[i]
        print(price_current)
        if  i == 0:
            ema_previous = subset['SMA_5'].iloc[0]
        else:
            ema_previous = EMA
        EMA = ema_formula(price_current, ema_previous, N)
        print(EMA)
        individual_ema.append(EMA)
    subset['EMA_5'] = individual_ema
    EMA_5.append(subset)

data = pd.concat(EMA_5, ignore_index=True)
data
```

```{python}

EMA_12 = []

for ticker in data["Ticker"].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_ema = []
    N = 12
    print(ticker)
    for i in range(0, len(subset)):
        print(i)
        price_current = subset['Close'].iloc[i]
        print(price_current)
        if  i == 0:
            ema_previous = subset['SMA_12'].iloc[0]
        else:
            ema_previous = EMA
        EMA = ema_formula(price_current, ema_previous, N)
        print(EMA)
        individual_ema.append(EMA)
    subset['EMA_12'] = individual_ema
    EMA_12.append(subset)

data= pd.concat(EMA_12, ignore_index=True)
data
```

```{python}
EMA_26 = []

for ticker in data["Ticker"].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_ema = []
    N = 26
    print(ticker)
    for i in range(0,len(subset)):
        print(i)
        price_current = subset['Close'].iloc[i]
        print(price_current)
        if i == 0:
            ema_previous = subset['SMA_26'].iloc[0]
        else:
            ema_previous = EMA
        EMA = ema_formula(price_current, ema_previous, N)
        print(EMA)
        individual_ema.append(EMA)
    subset['EMA_26'] = individual_ema
    EMA_26.append(subset)

data = pd.concat(EMA_26, ignore_index=True)
data
```

```{python}

EMA_50 = []

for ticker in data["Ticker"].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_ema = []
    N = 50
    print(ticker)
    for i in range(0,len(subset)): 
        print(i)
        price_current = subset['Close'].iloc[i]
        if i == 0:
            ema_previous = subset['SMA_50'].iloc[0]
        else:
            ema_previous = EMA
        EMA = ema_formula(price_current, ema_previous, N)
        individual_ema.append(EMA)
    subset['EMA_50'] = individual_ema
    EMA_50.append(subset)

data = pd.concat(EMA_50, ignore_index=True)
data
```

```{python}

MACD = []

def macd_formula(EMA_12, EMA_26):
    return EMA_12 - EMA_26


for ticker in data['Ticker'].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_macd = []
    print(ticker)
    for i in range(0,len(subset)):
        print(i)
        EMA_12 = subset['EMA_12'].iloc[i]
        EMA_26 = subset['EMA_26'].iloc[i]
        MACD_Vals = macd_formula(EMA_12, EMA_26)
        individual_macd.append(MACD_Vals)
    subset['MACD'] = individual_macd
    MACD.append(subset)

data = pd.concat(MACD, ignore_index=True)
data
```


```{python}
#RSI index by index

RSI = []
U = []
D = []
N = 14


subset = data[data['Ticker'] == 'CSCO']

change = subset['Close'].iloc[10] - subset['Close'].iloc[9]

if change > 0:
    U.append(Change)
    D.append(0)
else:
    U.append(0)
    D.append(abs(Change))

AU = np.sum(U) / N
AD = np.sum(D) / N
if AD == 0:
    RS = 100
else:
    RS = AU/AD
RSI = 100 - (100 / (1 + RS))
RSI

```


```{python}
#RSI looping through entire thing for one stock

RSI = []
U = []
D = []
N = 14

subset = data[data['Ticker'] == 'CSCO']
for i in range(1, len(subset)):
    change = subset['Close'].iloc[i] - subset['Close'].iloc[i -1 ]
    if change > 0:
        U.append(change)
        D.append(0)
    else:
        U.append(0)
        D.append(abs(change))
    AU = np.sum(U) / N
    AD = np.sum(D) / N
    if AD == 0:
        RS = 100
    else: 
        RS = AU/AD
    RSI_Vals = 100 - (100 / (1 + RS))
    RSI.append(RSI_Vals)

```

```{python}
#RSI looping through every stock every row

RSI = []
N = 14

for ticker in data['Ticker'].unique():
    U = []
    D = []
    individual_rsi = []
    subset = data[data['Ticker'] == ticker].copy()
    for i in range(0, len(subset)):
        change = subset['Close'].iloc[i] - subset['Close'].iloc[i -1 ]
        if change > 0: 
            U.append(change)
            D.append(0)
        else:
            U.append(0)
            D.append(abs(change))
        AU = np.sum(U) / N
        AD = np.sum(D) / N
        if AD == 0:
            RS = 100
        else: 
            RS = AU/AD
        RSI_Vals = 100 - (100 / (1 + RS))
        individual_rsi.append(RSI_Vals)
    subset['RSI'] = individual_rsi
    RSI.append(subset)

test = pd.concat(RSI, ignore_index=True)


```

Bollinger Bands:

Upper Band = 20 Day SMA + (20 DAY Standard Deviation * 2)
Middle Band = 20 Day SMA
Lower Band = 20 Day SMA - (20 DAY Standard Deviation * 2)

```{python}
#Middle Band
data = test
data['Bollinger_Band_Middle'] = data['SMA_20']


```

```{python}
#Calculates the SD for each
std_vals = data.groupby('Ticker')['Bollinger_Band_Middle'].std()
std_vals = std_vals.reset_index(name='SD')

```

```{python}
#Upper Band
SD_merge = pd.merge(data, std_vals, how = 'left', on = 'Ticker')
data = SD_merge
data.columns
data['Bollinger_Band_Upper'] = data['SMA_20'] +  2* data['SD']
data['Bollinger_Band_Lower'] = data['SMA_20'] -  2* data['SD']
```


On Balance Volume

```{python}
#calculate for one stock looping through

OBV = []
subset = data[data['Ticker'] == 'CSCO']

for i in range(1, len(subset)):
    close_change = subset['Close'].iloc[i] - subset['Close'].iloc[i-1]
    if close_change > 0:
        addend = subset['Volume']
    elif close_change < 0:
        addend = -(subset['Volume'])
    else: 
        addend = 0
    
    if i == 1:
        OBV_prev = 0
    else: 
        OBV_prev = OBV_individual[-1]
    OBV_val = OBV_prev + addend
    OBV.append(OBV_val)


test3 = pd.concat(OBV, ignore_index=True)
```


```{python}

OBV = []
for ticker in data['Ticker'].unique():
    subset = data[data['Ticker'] == ticker].copy()
    OBV_individual = []
    for i in range(len(subset)):
        if i == 0: 
            OBV_individual.append(0)
            continue

        close_change = subset['Close'].iloc[i] - subset['Close'].iloc[i-1]
        if close_change > 0: 
            addend = subset['Volume'].iloc[i]
        elif close_change < 0:
            addend = -(subset['Volume'].iloc[i])
        else: 
            addend = 0
       
        OBV_prev = OBV_individual[-1]
        OBV_val = OBV_prev + addend
        OBV_individual.append(OBV_val)
    subset['OBV'] = OBV_individual
    OBV.append(subset)
data = pd.concat(OBV, ignore_index=True)
```





```{python}
Day_to_Day_Diff = []

for ticker in data['Ticker'].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_d2d_diff = []
    print(ticker)
    for i in range(0,len(subset)):
        print(i)
        if i == 0:
            price_current = 0
            price_previous = 0
        else:
            price_current = subset['Close'].iloc[i]
            price_previous = subset['Close'].iloc[i-1]
        D2D_Diff_vals = price_current - price_previous
        individual_d2d_diff.append(D2D_Diff_vals)
    subset['Day_to_Day_Diff'] = individual_d2d_diff
    Day_to_Day_Diff.append(subset)
data = pd.concat(Day_to_Day_Diff, ignore_index=True)
```




```{python}
Day_to_Day_Percent_Diff = []

for ticker in data['Ticker'].unique():
    subset = data[data['Ticker'] == ticker].copy()
    individual_percent_diff = []
    for i in range(0, len(subset)):
        if i == 0:
            price_current = 0
            price_previous = 1000000000
        else: 
            price_current = subset['Close'].iloc[i]
            price_previous = subset['Close'].iloc[i-1]
        Percent_diff_values = ((price_current - price_previous) / price_previous) * 100
        individual_percent_diff.append(Percent_diff_values)
    subset['Day_to_Day_Percent_Diff'] = individual_percent_diff
    Day_to_Day_Percent_Diff.append(subset)

data = pd.concat(Day_to_Day_Percent_Diff, ignore_index=True)

```

```{python}
data.to_csv("FinalSP500DataWithDerived.csv", index=False)
```





Visuals for Short Report


```{python}
numeric_cols_subset = numeric_cols[numeric_cols['Date'] > '2025-10-01']
(ggplot(numeric_cols_subset, aes(x = 'Volume', y = 'Close')) + geom_point() + geom_smooth(color = 'blue')
)


```


```{python}
data2.dtypes
data2_subset = data[data2['Ticker'] == 'CSCO']
numeric_cols = data2_subset.drop(['Ticker'], axis=1)
ggplot(numeric_cols, aes(x='MACD', y= 'Close')) + geom_line() + theme_minimal() + labs(title = "MACD vs Close for CSCO Ticker")

```



```{python}
import pandas as pd
import yfinance as yf
data = pd.read_csv("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/DerivedVars.csv")
finaldf.head()
```

VIX

```{python}
ticker_symbol = "^VIX"
start_date = "2024-11-11"
end_date = "2025-11-10"


```

```{python}
try:
    vix_data = yf.download(
        tickers=ticker_symbol,
        start=start_date,
        end=end_date,
        interval="1d" 
    )

    vix_close_prices = vix_data['Close']

    print("VIX Closing Prices from {} to {}:".format(start_date, end_date))
    print(vix_close_prices)

except Exception as e:
    print(f"An error occurred: {e}")
```

```{python}
new = vix_close_prices.reset_index()
new.columns
test = pd.merge(data, new, how = 'left', on = 'Date')

```

Binary Classifier
```{python}
import pandas as pd
data = pd.read_csv("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/FinalDataWithConsumerSentiment.csv")
data['Movement'] = (data['Day_to_Day_Diff'] > 0).astype(int)

data.to_csv("FINALDATA.csv", index=False)
```