---
title: "Untitled"
format: html
---

```{python}
import pandas as pd 
import numpy as np   
from plotnine import *  
import xgboost as xgb 
from sklearn.model_selection import StratifiedShuffleSplit
from sklearn.impute import SimpleImputer
from sklearn.metrics import (
    accuracy_score, log_loss, roc_auc_score, confusion_matrix, classification_report, ConfusionMatrixDisplay, f1_score
)
from sklearn.model_selection import ParameterGrid
from tqdm import tqdm 
import matplotlib.pyplot as plt
import shap
from sklearn.metrics import roc_curve, roc_auc_score
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import r2_score
```


```{python}
train = pd.read_feather("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TrainData.feather")
test = pd.read_feather("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TestData.feather")
```




```{python}
X_train_raw = train.drop([
    'Daily_Return','next_day_pct_change','next_5_day_pct_change',
    'Movement_5_day','next_30_day_pct_change','Movement_30_day','Movement'
], axis=1)

X_train_raw = pd.get_dummies(X_train_raw, drop_first=True)

X_train_final = X_train_raw.apply(pd.to_numeric, errors='coerce').fillna(0)

y_train_final = train['next_5_day_pct_change'].astype(float)

dtrain = xgb.DMatrix(X_train_final, label=y_train_final)




test_clean = test.dropna(subset=['next_5_day_pct_change']).copy()

X_test_raw = test_clean.drop([
    'Daily_Return','next_day_pct_change','next_5_day_pct_change',
    'Movement_5_day','next_30_day_pct_change','Movement_30_day','Movement'
], axis=1)

X_test_raw = pd.get_dummies(X_test_raw, drop_first=True)
X_test_raw = X_test_raw.reindex(columns=X_train_raw.columns, fill_value=0)

X_test_final = X_test_raw.apply(pd.to_numeric, errors='coerce').fillna(0)

y_test_final = test_clean['next_5_day_pct_change'].astype(float)

dtest = xgb.DMatrix(X_test_final, label=y_test_final)

```

5 Day Prediction Initial Model

```{python}
params = {
   'objective': 'reg:squarederror',
   'eval_metric': 'rmse'
}
num_rounds = 1000
five_day_change_model = xgb.train(params, dtrain, num_rounds)
y_pred_five = five_day_change_model.predict(dtest)


```

Merging Data


```{python}
y_test_new = y_test_final.reset_index()
MAE_df = pd.DataFrame(y_pred_five).reset_index()
merged_MAE_df = pd.merge(y_test_new, MAE_df, how = 'inner', on = 'index')
merged_MAE_df = merged_MAE_df.drop('index', axis = 1)
merged_MAE_df.columns = ['Actual', 'Predicted']
merged_MAE_df['diff'] = merged_MAE_df['Actual'] - merged_MAE_df['Predicted']
merged_MAE_df_five = merged_MAE_df
```


Initial Model Accuracy Calc

```{python}
error = []
for i in range(0, len(merged_MAE_df+1)):
    diff = float(merged_MAE_df_five ['Actual'].iloc[i] - merged_MAE_df_five ['Predicted'].iloc[i])
    error.append(diff)
    MAE = (1/len(merged_MAE_df_five )) * sum(abs(merged_MAE_df_five ['Actual'] - merged_MAE_df_five ['Predicted']))

print(f"MAE for 5 Day Change: {MAE}")
```


MSE

1/n * sum(actual - predicted)^2

```{python}
error = []
for i in range(0, len(merged_MAE_df_five +1)):
    diff = float(merged_MAE_df_five ['Actual'].iloc[i] - merged_MAE_df_five ['Predicted'].iloc[i]) **2
    error.append(diff)
    MSE = (1/len(merged_MAE_df_five )) * sum(error)
```



R-Squared

R^2 =  1 - SSR/SST




```{python}
r_squared_5_Day = r2_score(merged_MAE_df_five ['Actual'],merged_MAE_df_five ['Predicted'])
```

Getting -.817


```{python}
threshold = 0.005
close_accuracy = np.mean(np.abs(y_pred - y_test_final) <= threshold)
print("Within Â±0.5% accuracy:", close_accuracy)

```