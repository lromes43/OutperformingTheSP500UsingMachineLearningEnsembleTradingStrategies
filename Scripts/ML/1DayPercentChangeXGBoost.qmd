---
title: "Untitled"
format: html
---


```{python}
import pandas as pd 
import numpy as np   
from plotnine import *  
import xgboost as xgb 
from sklearn.model_selection import StratifiedShuffleSplit
from sklearn.impute import SimpleImputer
from sklearn.metrics import (
    accuracy_score, log_loss, roc_auc_score, confusion_matrix, classification_report, ConfusionMatrixDisplay, f1_score
)
from sklearn.model_selection import ParameterGrid
from tqdm import tqdm 
import matplotlib.pyplot as plt
import shap
from sklearn.metrics import roc_curve, roc_auc_score
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import r2_score
```


```{python}
train = pd.read_feather("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TrainData.feather")
test = pd.read_feather("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TestData.feather")
```

Want to predict one day return % so use next_day_pct_change which is the % change day to day



```{python}
X_train_raw = train.drop([
    'Daily_Return','next_day_pct_change','next_5_day_pct_change',
    'Movement_5_day','next_30_day_pct_change','Movement_30_day','Movement'
], axis=1)

X_train_raw = pd.get_dummies(X_train_raw, drop_first=True)

X_train_final = X_train_raw.apply(pd.to_numeric, errors='coerce').fillna(0)

y_train_final = train['next_day_pct_change'].astype(float)

dtrain = xgb.DMatrix(X_train_final, label=y_train_final)




test_clean = test.dropna(subset=['next_day_pct_change']).copy()

X_test_raw = test_clean.drop([
    'Daily_Return','next_day_pct_change','next_5_day_pct_change',
    'Movement_5_day','next_30_day_pct_change','Movement_30_day','Movement'
], axis=1)

X_test_raw = pd.get_dummies(X_test_raw, drop_first=True)
X_test_raw = X_test_raw.reindex(columns=X_train_raw.columns, fill_value=0)

X_test_final = X_test_raw.apply(pd.to_numeric, errors='coerce').fillna(0)

y_test_final = test_clean['next_day_pct_change'].astype(float)

dtest = xgb.DMatrix(X_test_final, label=y_test_final)

```



```{python}
params = {
   'objective': 'reg:squarederror',
   'eval_metric': 'rmse'
}
num_rounds = 1000
model = xgb.train(params, dtrain, num_rounds)
y_pred = model.predict(dtest)

r2 = r2_score(y_test_final, y_pred)
print("R² accuracy:", r2)
```


```{python}
r2 = r2_score(y_test_final, y_pred)
print("R² accuracy:", r2)

mape = np.mean(np.abs((y_test_final - y_pred) / y_test_final)) * 100
print("MAPE (%):", mape)

accuracy_percent = 100 - mape
print("Approx Prediction Accuracy (%):", accuracy_percent)

```


```{python}
threshold = 0.005   
close_accuracy = np.mean(np.abs(y_pred - y_test_final) <= threshold)
print("Within ±0.2% accuracy:", close_accuracy)
```


```{python}
threshold = 0.005
close_accuracy = np.mean(np.abs(y_pred - y_test_final) <= threshold)
print("Within ±0.5% accuracy:", close_accuracy)

```