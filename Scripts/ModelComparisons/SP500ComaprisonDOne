
   ```{python}
cash = 0 

data = pd.read_feather("/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TestData.feather")

day1holdingsmerge = pd.merge(
    Holdings,
    data[['Date', 'Ticker', 'Close']],
    how='inner',
    left_on=['Stock', 'Date'],
    right_on=['Ticker', 'Date']
)

day1holdingsmerge = day1holdingsmerge.rename(columns={'Close': 'Buy_Price'})
day1holdingsmerge['Shares_Owned'] = 100000 / day1holdingsmerge['Buy_Price']
day1holdingsmerge['Buy_Date'] = day1_buys['Date'].values

date1 = day1holdingsmerge['Date'].iloc[0]
current_prices = data[data['Date'] == date1][['Ticker', 'Close']]
day1holdingsmerge = pd.merge(
    day1holdingsmerge.drop(columns=['current_price'], errors='ignore'),
    current_prices,
    how='left',
    left_on='Stock',
    right_on='Ticker'
)
day1holdingsmerge = day1holdingsmerge.rename(columns={'Close': 'current_price'})

def binary_preprocessing(date, file_path, predictor):
    import pandas as pd
    import joblib
    import xgboost as xgb
    
    binaryone = joblib.load("/Users/lukeromes/Desktop/Personal/Sp500Project/Models/FinalBoostedOneDayClassifier.joblib")
    data = pd.read_feather(file_path)

    subset = data[data['Date'] == date]

    drop_cols = [
        'Date', 'next_day_pct_change','Daily_Return',
        'next_5_day_pct_change','Movement_5_day',
        'next_30_day_pct_change','Movement_30_day',
        'Movement'
    ]
    X = subset.drop(drop_cols, axis=1)

    X_final = pd.get_dummies(X, drop_first=True)
    actual = subset[predictor].astype(int)
    dtest = xgb.DMatrix(X_final, label=actual)

    pred = binaryone.predict(dtest)
    pred_final = (pred >= 0.5).astype(int)

    pred_final_df = (
        pd.DataFrame(pred_final)
        .reset_index()
        .rename(columns={'index':'iteration', 0:'predicted_up'})
    )
    actual_df = (
        actual.reset_index()
        .reset_index()
        .drop('index', axis=1)
        .rename(columns={'level_0':'iteration', predictor:'actual_up'})
    )

    merged_binary = pd.merge(pred_final_df, actual_df, on='iteration')
    merged_binary['ticker'] = subset['Ticker'].sort_values().reset_index(drop=True)
    merged_binary['buy'] = merged_binary['actual_up'].apply(lambda x: 1 if x == 1 else 0)

    return merged_binary[merged_binary['buy'] == 1]


def cont_preprocessing(date, file_path, predictor):
    import pandas as pd
    import joblib
    import xgboost as xgb
    
    continuousone = joblib.load("/Users/lukeromes/Desktop/Personal/Sp500Project/Models/ContinuousOneDayFinal.joblib")
    data = pd.read_feather(file_path)

    subset = data[data['Date'] == date]

    drop_cols = [
        'Date','next_day_pct_change','Daily_Return',
        'next_5_day_pct_change','Movement_5_day',
        'next_30_day_pct_change','Movement_30_day',
        'Movement'
    ]
    X = subset.drop(drop_cols, axis=1)

    X_raw = pd.get_dummies(X, drop_first=True)
    X_final = X_raw.reindex(columns=continuousone.feature_names, fill_value=0).fillna(0)

    dtest = xgb.DMatrix(X_final)
    y_pred = continuousone.predict(dtest)

    merged = pd.DataFrame({
        'iteration': range(len(y_pred)),
        'Initial_Predicted': y_pred * 100,
        'ticker': subset['Ticker'].sort_values().reset_index(drop=True)
    })

    merged['buy'] = merged['Initial_Predicted'].apply(lambda x: 1 if x > 0 else 0)
    return merged[merged['buy'] == 1]

for date in sorted(data['Date'].unique()):

    binary = binary_preprocessing(date, "/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TestData.feather", "Movement")
    cont = cont_preprocessing(date, "/Users/lukeromes/Desktop/Personal/Sp500Project/Data/TestData.feather", "next_day_pct_change")

    merged = pd.merge(binary, cont, on=['iteration','ticker','buy'])
    merged = merged.sort_values("Initial_Predicted", ascending=False)

    daily = merged.head(10)

    removed_holdings = pd.DataFrame(columns=['Ticker','current_price','Shares_Owned'])

    for ticker in day1holdingsmerge['Stock'].tolist():      
        if ticker in merged['ticker'].values:
            continue
        else:
            row = day1holdingsmerge.loc[
            day1holdingsmerge['Stock'] == ticker,        
            ['Stock', 'current_price', 'Shares_Owned']]

        removed_holdings = pd.concat([removed_holdings, row], ignore_index=True)

        cash += row['current_price'].iloc[0] * row['Shares_Owned'].iloc[0]
        day1holdingsmerge = day1holdingsmerge[
            day1holdingsmerge['Stock'] != ticker        
        ].reset_index(drop=True)

        print("Removed holdings:\n", removed_holdings)

    for ticker in daily['ticker']:
        if ticker not in day1holdingsmerge['Stock'].values:

            price = data[
            (data['Date'] == date) &
            (data['Ticker'] == ticker)
            ]['Close'].iloc[0]

            shares_to_buy = cash / price if cash > 0 else 0

            new_row = pd.DataFrame([{
            'Stock': ticker,
            'Buy_Price': price,
            'Shares_Owned': shares_to_buy,
            'Buy_Date': date,
            'current_price': price
            }])

            day1holdingsmerge = pd.concat([day1holdingsmerge, new_row], ignore_index=True)

            cash = 0
            break  
    day_prices = data[data['Date'] == date][['Ticker', 'Close']]

    day1holdingsmerge = pd.merge(
        day1holdingsmerge.drop(columns=['current_price'], errors='ignore'),
        day_prices.rename(columns={'Ticker': 'Stock'}),
        how='left',
        on='Stock'
    )

    day1holdingsmerge = day1holdingsmerge.rename(columns={'Close': 'current_price'})
   ```




```{python}

latest_date = data['Date'].max()  
current_prices = data[data['Date'] == latest_date][['Ticker', 'Close']]


holdings_for_profit = day1holdingsmerge.rename(columns={'Stock': 'Ticker'})


holdings_with_prices = pd.merge(
    holdings_for_profit,
    current_prices,
    how='left',
    on='Ticker'
)


holdings_with_prices['Profit'] = (holdings_with_prices['Close'] - holdings_with_prices['Buy_Price']) * holdings_with_prices['Shares_Owned']

total_profit = holdings_with_prices['Profit'].sum()
print("Total Profit:", total_profit)


```


```{python}
portfolio_value = (day1holdingsmerge['current_price'] * day1holdingsmerge['Shares_Owned']).sum() + cash

total_invested = (day1holdingsmerge['Buy_Price'] * day1holdingsmerge['Shares_Owned']).sum() + 0  

total_profit = portfolio_value - total_invested
print("Total Profit:", total_profit)
```


Compared to SP500 Baseline

6448.26
6849.72